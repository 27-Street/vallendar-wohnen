---
import type { Language } from '../i18n/translations';
import { getTranslation } from '../i18n/translations';

interface Props {
  images: Array<{
    image: string;
    kind: string;
    caption?: {
      de: string;
      en: string;
    };
    isPrimary?: boolean;
  }>;
  apartmentName: string;
  lang: Language;
}

const { images, apartmentName, lang } = Astro.props;
const t = getTranslation(lang);
const orderedImages = [...images].sort((a, b) => Number(Boolean(b.isPrimary)) - Number(Boolean(a.isPrimary)));

const galleryId = `gallery-${apartmentName.toLowerCase().replace(/\s+/g, '-').normalize('NFD').replace(/[\u0300-\u036f]/g, '')}`;

const isPlaceholder = (src: string) => src.endsWith('.svg');
---

<!-- Gallery Grid -->
<div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4 lg:grid-rows-2" id={galleryId}>
  {orderedImages.map((entry, i) => (
    <button
      type="button"
      class:list={[
        'gallery-thumb group relative overflow-hidden rounded-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 focus-visible:ring-offset-2',
        i === 0
          ? 'sm:col-span-2 lg:row-span-2 aspect-[16/10] sm:aspect-[16/10] lg:aspect-auto lg:h-full'
          : 'aspect-[4/3]',
      ]}
      data-index={i}
      aria-label={`${apartmentName} — ${t.gallery.viewImage} ${i + 1}`}
    >
      {isPlaceholder(entry.image) ? (
        <div class="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-gradient-to-br from-accent-100 to-accent-200 transition-transform duration-300 group-hover:scale-105">
          <div class="text-center px-4">
            <p class="text-sm font-semibold text-accent-700/60">{apartmentName}</p>
            <p class="mt-0.5 text-xs text-accent-500/50">{t.gallery.photoComingSoon}</p>
          </div>
        </div>
      ) : (
        <img
          src={entry.image}
          alt={entry.caption?.[lang] ? `${apartmentName} — ${entry.caption[lang]}` : `${apartmentName} — ${i + 1}`}
          loading={i === 0 ? 'eager' : 'lazy'}
          decoding="async"
          fetchpriority={i === 0 ? 'high' : 'auto'}
          width="1600"
          height="1200"
          class="absolute inset-0 h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
        />
      )}

      {/* Hover overlay */}
      <div class="absolute inset-0 bg-accent-950/0 transition-colors duration-200 group-hover:bg-accent-950/10" />

      {/* Expand icon */}
      <div class="absolute bottom-2 right-2 rounded-lg bg-white/80 p-1.5 opacity-0 shadow-sm backdrop-blur-sm transition-opacity duration-200 group-hover:opacity-100">
        <svg class="h-4 w-4 text-accent-700" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
        </svg>
      </div>
    </button>
  ))}
</div>


<!-- Lightbox Dialog -->
<dialog
  id={`${galleryId}-lightbox`}
  class="gallery-lightbox m-0 h-full w-full max-h-full max-w-full bg-neutral-950/95 p-0 backdrop:bg-transparent"
>
  <div class="flex h-full w-full flex-col items-center justify-center">
    <!-- Close button -->
    <button
      type="button"
      class="lightbox-close absolute top-4 right-4 z-10 rounded-full bg-white/10 p-2.5 text-white/80 transition-colors hover:bg-white/20 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
      aria-label={t.gallery.close}
    >
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Counter -->
    <div class="absolute top-4 left-4 z-10 rounded-full bg-white/10 px-3 py-1.5 text-sm font-medium text-white/80">
      <span class="lightbox-current">1</span> / {orderedImages.length}
    </div>

    <!-- Navigation -->
    {orderedImages.length > 1 && (
      <>
        <button
          type="button"
          class="lightbox-prev absolute left-4 top-1/2 z-10 -translate-y-1/2 rounded-full bg-white/10 p-3 text-white/80 transition-colors hover:bg-white/20 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
          aria-label={t.gallery.previous}
        >
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
          </svg>
        </button>
        <button
          type="button"
          class="lightbox-next absolute right-4 top-1/2 z-10 -translate-y-1/2 rounded-full bg-white/10 p-3 text-white/80 transition-colors hover:bg-white/20 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
          aria-label={t.gallery.next}
        >
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
        </button>
      </>
    )}

    <!-- Image display area -->
    <div class="lightbox-content flex h-full w-full items-center justify-center px-4 py-16 sm:px-16 sm:py-20">
      {orderedImages.map((entry, i) => (
        <div
          class:list={[
            'lightbox-slide absolute flex items-center justify-center',
            i === 0 ? '' : 'hidden',
          ]}
          data-slide={i}
        >
          {isPlaceholder(entry.image) ? (
            <div class="flex aspect-[16/10] w-full max-w-4xl flex-col items-center justify-center gap-4 rounded-2xl bg-gradient-to-br from-accent-100 to-accent-200">
              <div class="text-center">
                <p class="text-lg font-semibold text-accent-700/60">{apartmentName}</p>
                <p class="mt-1 text-sm text-accent-500/50">{t.gallery.photoComingSoon}</p>
              </div>
            </div>
          ) : (
            <img
              src={entry.image}
              alt={entry.caption?.[lang] ? `${apartmentName} — ${entry.caption[lang]}` : `${apartmentName} — ${i + 1}`}
              loading="lazy"
              class="max-h-[80vh] max-w-full rounded-lg object-contain"
            />
          )}
        </div>
      ))}
    </div>
  </div>
</dialog>

<script define:vars={{ galleryId, imageCount: orderedImages.length }}>
  document.addEventListener('DOMContentLoaded', () => {
    const gallery = document.getElementById(galleryId);
    const dialog = document.getElementById(`${galleryId}-lightbox`);
    if (!gallery || !dialog) return;

    let currentIndex = 0;
    const slides = dialog.querySelectorAll('.lightbox-slide');
    const counter = dialog.querySelector('.lightbox-current');
    const closeBtn = dialog.querySelector('.lightbox-close');
    const prevBtn = dialog.querySelector('.lightbox-prev');
    const nextBtn = dialog.querySelector('.lightbox-next');

    function showSlide(index) {
      currentIndex = (index + imageCount) % imageCount;
      slides.forEach((slide, i) => {
        slide.classList.toggle('hidden', i !== currentIndex);
      });
      if (counter) counter.textContent = String(currentIndex + 1);
    }

    // Open lightbox on thumbnail click
    gallery.querySelectorAll('.gallery-thumb').forEach((thumb) => {
      thumb.addEventListener('click', () => {
        const index = parseInt(thumb.getAttribute('data-index') || '0', 10);
        showSlide(index);
        dialog.showModal();
      });
    });

    // Close button
    if (closeBtn) {
      closeBtn.addEventListener('click', () => dialog.close());
    }

    // Click on backdrop area (outside content) closes dialog
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog || !e.target.closest('.lightbox-content, .lightbox-close, .lightbox-prev, .lightbox-next, .lightbox-current')) {
        dialog.close();
      }
    });

    // Navigation
    if (prevBtn) {
      prevBtn.addEventListener('click', () => showSlide(currentIndex - 1));
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', () => showSlide(currentIndex + 1));
    }

    // Keyboard navigation
    dialog.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        showSlide(currentIndex - 1);
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        showSlide(currentIndex + 1);
      }
    });
  });
</script>

<style>
  .gallery-lightbox::backdrop {
    background: transparent;
  }

  .gallery-lightbox[open] {
    animation: fadeIn 200ms ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>
