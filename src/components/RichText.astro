---
import { marked } from 'marked';
import sanitizeHtml from 'sanitize-html';
import {
  RICH_TEXT_ALLOWED_ATTRIBUTES,
  RICH_TEXT_ALLOWED_SCHEMES,
  RICH_TEXT_ALLOWED_TAGS,
  RICH_TEXT_MARKED_OPTIONS,
} from '../lib/rich-text-config';

interface Props {
  content: string;
  className?: string;
}

const { content, className = '' } = Astro.props;

const rawHtml = marked.parse(content ?? '', RICH_TEXT_MARKED_OPTIONS) as string;

const sanitizedHtml = sanitizeHtml(rawHtml, {
  allowedTags: [...RICH_TEXT_ALLOWED_TAGS],
  allowedAttributes: {
    ...sanitizeHtml.defaults.allowedAttributes,
    ...RICH_TEXT_ALLOWED_ATTRIBUTES,
  },
  allowedSchemes: [...RICH_TEXT_ALLOWED_SCHEMES],
  transformTags: {
    a: (_tagName, attribs) => {
      const href = attribs.href ?? '';
      const isExternal = /^https?:\/\//.test(href);
      return {
        tagName: 'a',
        attribs: {
          ...attribs,
          rel: 'noopener noreferrer',
          ...(isExternal ? { target: '_blank' } : {}),
        },
      };
    },
    img: (_tagName, attribs) => ({
      tagName: 'img',
      attribs: {
        ...attribs,
        loading: attribs.loading ?? 'lazy',
      },
    }),
  },
});
---

<div class:list={['richtext', className]} set:html={sanitizedHtml} />
