---
import type { GetStaticPaths } from 'astro';
import { Icon } from 'astro-icon/components';
import BaseLayout from '../../layouts/BaseLayout.astro';
import FAQAccordion from '../../components/FAQAccordion.astro';
import RichText from '../../components/RichText.astro';
import { getContentPages, getPageSlug, type ContentPageEntry } from '../../lib/content-pages';
import { getTranslation } from '../../i18n/translations';
import { translatePath } from '../../i18n/utils';
import { buildFaqPageSchema, getSiteOrigin } from '../../lib/seo';

export const getStaticPaths: GetStaticPaths = async () => {
  const pages = await getContentPages();
  return pages
    .map((page) => getPageSlug(page, 'de'))
    .filter((slug) => slug.length > 0)
    .map((slug) => ({ params: { slug } }));
};

const lang = 'de' as const;
const t = getTranslation(lang);
const slug = Astro.params.slug ?? '';
const contentPages = await getContentPages();
const page = contentPages.find((entry) => getPageSlug(entry, lang) === slug) as ContentPageEntry | undefined;

if (!page) {
  return Astro.redirect('/de/');
}

const d = page.data;
const pageType = d.pageType ?? 'standard';
const siteOrigin = getSiteOrigin(Astro.site);
const canonicalPath = `/${lang}/${slug}/`;
const pageUrl = `${siteOrigin}${canonicalPath}`;

const title = d.seo?.title?.[lang]
  || (pageType === 'faq'
    ? 'Häufige Fragen | VallendarWohnen'
    : pageType === 'exchange'
      ? 'Für Austauschstudierende | VallendarWohnen'
      : `${d.heading?.[lang] || d.title} | VallendarWohnen`);

const description = d.seo?.description?.[lang]
  || d.intro?.[lang]
  || d.subheading?.[lang]
  || 'Informationen zu unseren Studentenwohnungen in Vallendar.';

const localizedFaq = (d.faq ?? []).map((item) => ({
  question: item.question[lang],
  answer: item.answer[lang],
}));

const structuredData = pageType === 'faq' && localizedFaq.length > 0
  ? [buildFaqPageSchema(pageUrl, localizedFaq)]
  : [];
---

<BaseLayout
  title={title}
  description={description}
  lang={lang}
  ogImage={d.seo?.ogImage}
  ogImageAlt={d.seo?.ogImageAlt?.[lang]}
  keywords={d.seo?.keywords}
  structuredData={structuredData}
>
  {pageType === 'faq' ? (
    <>
      <section class="bg-gradient-to-br from-accent-950 via-accent-800 to-accent-950 pb-16 pt-32">
        <div class="mx-auto max-w-6xl px-4 sm:px-6">
          <h1 class="text-4xl font-bold tracking-tight text-white sm:text-5xl">
            {d.heading?.[lang] || t.sections.faq}
          </h1>
          <p class="mt-4 text-lg text-accent-100/80">
            {d.subheading?.[lang] || 'Alles, was Sie vor einer Anfrage wissen sollten.'}
          </p>
        </div>
      </section>

      <section class="bg-white py-16 sm:py-20">
        <div class="mx-auto max-w-3xl px-4 sm:px-6">
          <FAQAccordion items={localizedFaq} />
          <div class="mt-10 rounded-xl border border-neutral-200 bg-neutral-50 p-6">
            <h2 class="font-serif text-xl font-bold text-neutral-900">Mehr Tipps für Austauschstudierende</h2>
            <p class="mt-3 text-sm text-neutral-600">Weitere Antworten finden Sie in unseren ausführlichen Guides zu Anreise, Budget und Wohnungsbuchung.</p>
            <a href="/de/guides/" class="mt-4 inline-flex text-sm font-semibold text-accent-700 hover:text-accent-900">Zu den Guides →</a>
          </div>
        </div>
      </section>
    </>
  ) : pageType === 'exchange' ? (
    <>
      <section class="bg-gradient-to-br from-accent-950 via-accent-800 to-accent-950 pb-16 pt-32">
        <div class="mx-auto max-w-6xl px-4 sm:px-6">
          <h1 class="font-serif text-4xl font-bold text-white sm:text-5xl">
            {d.heading?.[lang]}
          </h1>
          <p class="mt-4 text-lg text-accent-100/80">
            {d.subheading?.[lang]}
          </p>
        </div>
      </section>

      <section class="bg-white py-16 sm:py-20">
        <div class="mx-auto max-w-3xl px-4 sm:px-6">
          <p class="text-lg leading-relaxed text-neutral-700">
            {d.intro?.[lang]}
          </p>
        </div>
      </section>

      {d.highlights && d.highlights.length > 0 && (
        <section class="bg-neutral-50 py-16 sm:py-20">
          <div class="mx-auto max-w-6xl px-4 sm:px-6">
            <h2 class="text-center font-serif text-3xl font-bold text-neutral-900 sm:text-4xl">
              {t.sections.features}
            </h2>
            <div class="mt-12 grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
              {d.highlights.map((item) => (
                <div class="rounded-xl bg-white p-6 ring-1 ring-neutral-200 transition-all duration-200 hover:shadow-md hover:ring-accent-200">
                  <span class="flex h-12 w-12 items-center justify-center rounded-lg bg-accent-100 text-accent-700">
                    <Icon name={`lucide:${item.icon}`} class="h-5 w-5" />
                  </span>
                  <h3 class="mt-4 text-base font-semibold text-neutral-900">
                    {item.title[lang]}
                  </h3>
                  <p class="mt-2 text-sm leading-relaxed text-neutral-600">
                    {item.description[lang]}
                  </p>
                </div>
              ))}
            </div>
          </div>
        </section>
      )}

      <section class="bg-white py-16 sm:py-20">
        <div class="mx-auto max-w-3xl px-4 sm:px-6">
          <h2 class="font-serif text-2xl font-bold text-neutral-900 sm:text-3xl">
            Was ist enthalten?
          </h2>
          <p class="mt-6 text-base leading-relaxed text-neutral-700">
            {d.whatsIncluded?.[lang]}
          </p>
        </div>
      </section>

      <section class="bg-neutral-50 py-16 sm:py-20">
        <div class="mx-auto max-w-3xl px-4 sm:px-6">
          <h2 class="font-serif text-2xl font-bold text-neutral-900 sm:text-3xl">
            Über Vallendar
          </h2>
          <p class="mt-6 text-base leading-relaxed text-neutral-700">
            {d.aboutVallendar?.[lang]}
          </p>
        </div>
      </section>

      <section class="bg-white py-16 sm:py-20">
        <div class="mx-auto max-w-3xl px-4 sm:px-6">
          <h2 class="font-serif text-2xl font-bold text-neutral-900 sm:text-3xl">
            Buchung aus dem Ausland
          </h2>
          <p class="mt-6 text-base leading-relaxed text-neutral-700">
            {d.remoteBooking?.[lang]}
          </p>
        </div>
      </section>

      <section class="bg-gradient-to-br from-accent-950 via-accent-800 to-accent-950 py-16 sm:py-20">
        <div class="mx-auto max-w-3xl px-4 text-center sm:px-6">
          <h2 class="font-serif text-3xl font-bold text-white sm:text-4xl">
            Bereit für Ihr Semester in Vallendar?
          </h2>
          <p class="mx-auto mt-4 max-w-xl text-accent-100/80">
            Senden Sie uns eine unverbindliche Anfrage — wir melden uns innerhalb von 24 Stunden.
          </p>
          <a
            href={translatePath('/kontakt', lang)}
            class="btn btn-light mt-[3.4375rem]"
          >
            {d.ctaText?.[lang] || 'Jetzt Anfrage senden'}
            <Icon name="lucide:arrow-right" class="h-4 w-4" />
          </a>
        </div>
      </section>
    </>
  ) : (
    <>
      <section class="bg-gradient-to-br from-accent-950 via-accent-800 to-accent-950 pb-16 pt-32">
        <div class="mx-auto max-w-6xl px-4 sm:px-6">
          <h1 class="font-serif text-4xl font-bold text-white sm:text-5xl">
            {d.heading?.[lang] || d.title}
          </h1>
          {d.subheading?.[lang] && (
            <p class="mt-4 text-lg text-accent-100/80">{d.subheading[lang]}</p>
          )}
        </div>
      </section>

      <section class="bg-white py-16 sm:py-20">
        <div class="mx-auto max-w-4xl px-4 sm:px-6">
          {d.intro?.[lang] && <p class="text-lg leading-relaxed text-neutral-700">{d.intro[lang]}</p>}
          <div class="mt-10 space-y-10">
            {(d.sections ?? []).map((section) => (
              <article>
                <h2 class="font-serif text-2xl font-bold text-neutral-900">{section.heading[lang]}</h2>
                <RichText content={section.body[lang]} className="mt-4" />
              </article>
            ))}
          </div>
        </div>
      </section>

      {localizedFaq.length > 0 && (
        <section class="bg-neutral-50 py-16 sm:py-20">
          <div class="mx-auto max-w-4xl px-4 sm:px-6">
            <h2 class="font-serif text-3xl font-bold text-neutral-900">Häufige Fragen</h2>
            <div class="mt-8">
              <FAQAccordion items={localizedFaq} />
            </div>
          </div>
        </section>
      )}
    </>
  )}
</BaseLayout>
