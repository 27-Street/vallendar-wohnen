---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import AvailabilityBadge from '../../../components/AvailabilityBadge.astro';
import ImageGallery from '../../../components/ImageGallery.astro';
import InquiryForm from '../../../components/InquiryForm.astro';
import RichText from '../../../components/RichText.astro';
import { getTranslation } from '../../../i18n/translations';
import { getSiteOrigin } from '../../../lib/seo';

export const getStaticPaths: GetStaticPaths = async () => {
  const apartments = await getCollection('apartments');
  return apartments.map((apt) => ({
    params: { id: apt.id },
    props: { apartment: apt },
  }));
};

const lang = 'de' as const;
const t = getTranslation(lang);
const { apartment } = Astro.props;
const apt = apartment.data;
const total = apt.pricePerMonth + apt.utilitiesPerMonth;
const plainDescription = apt.description[lang].replace(/[#*_`>-]/g, '').replace(/\n+/g, ' ').trim();
const seoTitle = apt.seo?.title?.[lang]?.trim()
  || `${apt.name} – ${apt.size} m², ab ${apt.pricePerMonth} €/Monat | VallendarWohnen`;
const seoDescription = apt.seo?.description?.[lang]?.trim()
  || `${apt.name} in Vallendar: ${plainDescription} ${apt.rooms[lang]}, ${apt.size} m², ab ${apt.pricePerMonth} €/Monat.`;
const primaryImage = apt.images.find((image) => image.isPrimary) ?? apt.images[0];
const seoImage = apt.seo?.ogImage?.trim() || primaryImage?.image || `/og-default.png`;
const seoImageAlt = apt.seo?.ogImageAlt?.[lang] || `${apt.name} in Vallendar`;
const parsedRoomCount = Number.parseFloat(apt.rooms[lang].replace(',', '.').match(/\d+(\.\d+)?/)?.[0] ?? '0');

const siteOrigin = getSiteOrigin(Astro.site);
const apartmentJsonLd = {
  "@context": "https://schema.org",
  "@type": "Apartment",
  "name": apt.name,
  "description": plainDescription,
  "url": `${siteOrigin}/de/wohnungen/${apartment.id}/`,
  "floorSize": {
    "@type": "QuantitativeValue",
    "value": apt.size,
    "unitCode": "MTK",
    "unitText": "m²"
  },
  "numberOfRooms": parsedRoomCount || undefined,
  "floorLevel": apt.floor[lang],
  "amenityFeature": apt.amenities.map((a) => ({
    "@type": "LocationFeatureSpecification",
    "name": a[lang],
    "value": true
  })),
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Musterstraße 1",
    "addressLocality": "Vallendar",
    "postalCode": "56179",
    "addressCountry": "DE"
  },
  "offers": {
    "@type": "Offer",
    "priceCurrency": "EUR",
    "price": Number(apt.pricePerMonth.toFixed(2)),
    "unitCode": "MON",
    "availability": apt.available ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
    "url": `${siteOrigin}/de/wohnungen/${apartment.id}/`,
    "priceSpecification": {
      "@type": "UnitPriceSpecification",
      "price": Number(apt.pricePerMonth.toFixed(2)),
      "priceCurrency": "EUR",
      "unitCode": "MON"
    },
    "description": `Kaltmiete ${apt.pricePerMonth} € + Nebenkosten ${apt.utilitiesPerMonth} € = ${total} €/Monat`
  }
};
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  lang={lang}
  ogImage={seoImage}
  ogImageAlt={seoImageAlt}
  structuredData={[apartmentJsonLd]}
>
  <!-- Hero Area -->
  <section class="bg-gradient-to-br from-accent-950 via-accent-800 to-accent-950 pb-16 pt-32">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      <a
        href={`/${lang}/#wohnungen`}
        class="inline-flex items-center gap-1 text-sm font-medium text-accent-200 transition-colors hover:text-white"
      >
        <Icon name="lucide:arrow-left" class="h-4 w-4" />
        {t.apartment.backToAll}
      </a>

      <div class="mt-6 flex flex-wrap items-start gap-4">
        <h1 class="font-serif text-4xl font-bold text-white sm:text-5xl">
          {apt.name}
        </h1>
        <div class="mt-1 sm:mt-2">
          <AvailabilityBadge available={apt.available} availableFrom={apt.availableFrom} lang={lang} variant="hero" />
        </div>
      </div>
      <p class="mt-3 text-lg text-accent-100/80">{apt.tagline[lang]}</p>
    </div>
  </section>

  <!-- Image Gallery -->
  <section class="bg-neutral-50 py-12">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      <ImageGallery images={apt.images} apartmentName={apt.name} lang={lang} />
    </div>
  </section>

  <!-- Details Section -->
  <section class="bg-white py-16 sm:py-20">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      <div class="grid gap-10 lg:grid-cols-3">
        <!-- Left: Description & Details -->
        <div class="lg:col-span-2">
          <h2 class="font-serif text-2xl font-bold text-neutral-900">
            {apt.name}
          </h2>
          <RichText content={apt.description[lang]} className="mt-4" />

          <div class="mt-8 grid grid-cols-2 gap-4 sm:grid-cols-4">
            <div class="rounded-xl bg-neutral-50 p-4 ring-1 ring-neutral-100 transition-shadow duration-200 hover:shadow-sm">
              <p class="text-xs font-medium text-neutral-500 uppercase tracking-wider">{t.apartment.size}</p>
              <p class="mt-1 text-lg font-bold text-neutral-900">{apt.size} m²</p>
            </div>
            <div class="rounded-xl bg-neutral-50 p-4 ring-1 ring-neutral-100 transition-shadow duration-200 hover:shadow-sm">
              <p class="text-xs font-medium text-neutral-500 uppercase tracking-wider">{t.apartment.rooms}</p>
              <p class="mt-1 text-lg font-bold text-neutral-900">{apt.rooms[lang]}</p>
            </div>
            <div class="rounded-xl bg-neutral-50 p-4 ring-1 ring-neutral-100 transition-shadow duration-200 hover:shadow-sm">
              <p class="text-xs font-medium text-neutral-500 uppercase tracking-wider">{t.apartment.floor}</p>
              <p class="mt-1 text-lg font-bold text-neutral-900">{apt.floor[lang]}</p>
            </div>
            <div class="rounded-xl bg-neutral-50 p-4 ring-1 ring-neutral-100 transition-shadow duration-200 hover:shadow-sm">
              <p class="text-xs font-medium text-neutral-500 uppercase tracking-wider">{t.apartment.maxOccupants}</p>
              <p class="mt-1 text-lg font-bold text-neutral-900">{apt.maxOccupants}</p>
            </div>
          </div>
        </div>

        <!-- Right: Pricing Card -->
        <div>
          <div class="rounded-2xl bg-neutral-50 p-6 ring-1 ring-neutral-200">
            <h3 class="text-lg font-bold text-neutral-900">{t.apartment.rentalCosts}</h3>

            <div class="mt-5 space-y-3">
              <div class="flex items-center justify-between text-sm">
                <span class="text-neutral-600">{t.apartment.rent}</span>
                <span class="font-semibold text-neutral-900">{apt.pricePerMonth} €</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-neutral-600">{t.apartment.utilities}</span>
                <span class="font-semibold text-neutral-900">{apt.utilitiesPerMonth} €</span>
              </div>
              <div class="border-t border-neutral-200 pt-3">
                <div class="flex items-center justify-between">
                  <span class="font-semibold text-neutral-900">{t.apartment.total}</span>
                  <span class="text-xl font-bold text-accent-700">{total} € <span class="text-sm font-normal text-neutral-500">{t.apartment.perMonth}</span></span>
                </div>
              </div>
            </div>

            <div class="mt-6">
              <AvailabilityBadge available={apt.available} availableFrom={apt.availableFrom} lang={lang} />
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Amenities Section -->
  <section class="bg-neutral-50 py-16 sm:py-20">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      <h2 class="font-serif text-2xl font-bold text-neutral-900">{t.apartment.amenities}</h2>
      <div class="mt-8 grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4">
        {apt.amenities.map((amenity) => (
          <div class="flex items-center gap-3 rounded-xl bg-white p-4 ring-1 ring-neutral-200 transition-all duration-200 hover:shadow-sm hover:ring-accent-200">
            <Icon name="lucide:check" class="h-5 w-5 shrink-0 text-accent-600" />
            <span class="min-w-0 break-words text-sm font-medium text-neutral-800">{amenity[lang]}</span>
          </div>
        ))}
      </div>
    </div>
  </section>

  <section class="bg-white py-8">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      <div class="rounded-2xl border border-neutral-200 bg-neutral-50 p-6">
        <h2 class="font-serif text-xl font-bold text-neutral-900">Neu in Vallendar?</h2>
        <p class="mt-2 text-sm text-neutral-600">Unsere Exchange-Guides helfen bei Anreise, Budget und Organisation Ihres Semesters.</p>
        <a href="/de/guides/" class="mt-4 inline-flex text-sm font-semibold text-accent-700 hover:text-accent-900">
          Guides ansehen →
        </a>
      </div>
    </div>
  </section>

  <!-- Booking Inquiry Form -->
  <section class="bg-white py-16 sm:py-20">
    <div class="mx-auto max-w-3xl px-4 sm:px-6">
      <h2 class="font-serif text-2xl font-bold text-neutral-900">
        {t.apartment.inquiryHeading}
      </h2>
      <p class="mt-3 text-neutral-600">
        {t.apartment.inquiryIntro}
      </p>
      <div class="mt-8">
        <InquiryForm lang={lang} apartmentName={apt.name} formName={`apartment-inquiry-${apartment.id}`} />
      </div>
    </div>
  </section>

  <!-- Back Link -->
  <section class="bg-white py-8">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      <a
        href={`/${lang}/#wohnungen`}
        class="inline-flex items-center gap-1 text-sm font-medium text-accent-700 transition-colors hover:text-accent-900"
      >
        <Icon name="lucide:arrow-left" class="h-4 w-4" />
        {t.apartment.backToAll}
      </a>
    </div>
  </section>
</BaseLayout>
