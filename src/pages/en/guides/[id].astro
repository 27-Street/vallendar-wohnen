---
import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import FAQAccordion from '../../../components/FAQAccordion.astro';
import RichText from '../../../components/RichText.astro';
import { buildFaqPageSchema, getSiteOrigin, toAbsoluteUrl } from '../../../lib/seo';

export const getStaticPaths: GetStaticPaths = async () => {
  const guides = await getCollection('guides');
  return guides.map((guide) => ({
    params: { id: guide.id },
    props: { guide },
  }));
};

const lang = 'en' as const;
const { guide } = Astro.props as { guide: CollectionEntry<'guides'> };
const siteOrigin = getSiteOrigin(Astro.site);
const pageUrl = `${siteOrigin}/en/guides/${guide.id}/`;
const localizedFaq = (guide.data.faq ?? []).map((item) => ({
  question: item.question[lang],
  answer: item.answer[lang],
}));

const structuredData: Array<Record<string, unknown>> = [{
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: guide.data.title[lang],
  description: guide.data.description[lang],
  datePublished: guide.data.publishedAt,
  inLanguage: 'en-US',
  mainEntityOfPage: pageUrl,
  image: guide.data.heroImage ? toAbsoluteUrl(siteOrigin, guide.data.heroImage) : undefined,
  author: {
    '@type': 'Organization',
    name: 'VallendarWohnen',
  },
}];

if (localizedFaq.length > 0) {
  structuredData.push(buildFaqPageSchema(pageUrl, localizedFaq));
}

const seo = guide.data.seo;
const title = seo?.title?.[lang] ?? `${guide.data.title[lang]} | VallendarWohnen`;
const description = seo?.description?.[lang] ?? guide.data.description[lang];
const ogImage = seo?.ogImage ?? guide.data.heroImage ?? '/og-default.png';
const ogImageAlt = seo?.ogImageAlt?.[lang] ?? guide.data.title[lang];
---

<BaseLayout
  title={title}
  description={description}
  lang={lang}
  ogImage={ogImage}
  ogImageAlt={ogImageAlt}
  structuredData={structuredData}
  keywords={seo?.keywords}
>
  <section class="bg-gradient-to-br from-accent-950 via-accent-800 to-accent-950 pb-16 pt-32">
    <div class="mx-auto max-w-5xl px-4 sm:px-6">
      <a href="/en/guides/" class="text-sm font-semibold text-accent-200 hover:text-white">← Back to all guides</a>
      <h1 class="mt-4 font-serif text-4xl font-bold text-white sm:text-5xl">{guide.data.title.en}</h1>
      <p class="mt-4 max-w-3xl text-lg text-accent-100/85">{guide.data.description.en}</p>
      <p class="mt-3 text-sm font-medium text-accent-200">{guide.data.publishedAt} · {guide.data.readingMinutes} min read</p>
    </div>
  </section>

  <section class="bg-white py-16 sm:py-20">
    <div class="mx-auto max-w-4xl space-y-10 px-4 sm:px-6">
      {guide.data.sections.map((section) => (
        <article>
          <h2 class="font-serif text-2xl font-bold text-neutral-900">{section.heading.en}</h2>
          <RichText content={section.body.en} className="mt-4" />
        </article>
      ))}
    </div>
  </section>

  {localizedFaq.length > 0 && (
    <section class="bg-neutral-50 py-16 sm:py-20">
      <div class="mx-auto max-w-4xl px-4 sm:px-6">
        <h2 class="font-serif text-3xl font-bold text-neutral-900">Frequently Asked Questions</h2>
        <div class="mt-8">
          <FAQAccordion items={localizedFaq} />
        </div>
      </div>
    </section>
  )}

  <section class="bg-white py-16 sm:py-20">
    <div class="mx-auto max-w-4xl rounded-2xl border border-neutral-200 bg-neutral-50 p-8 px-4 sm:px-8">
      <h2 class="font-serif text-2xl font-bold text-neutral-900">Next Step</h2>
      <p class="mt-3 text-neutral-700">View available apartments and send your inquiry directly.</p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="/en/#apartments" class="rounded-full bg-accent-700 px-5 py-2.5 text-sm font-semibold text-white hover:bg-accent-800">
          View apartments
        </a>
        <a href="/en/contact/" class="rounded-full border border-accent-700 px-5 py-2.5 text-sm font-semibold text-accent-700 hover:bg-accent-50">
          Contact us
        </a>
      </div>
    </div>
  </section>
</BaseLayout>
