---
import { getCollection, getEntry } from 'astro:content';
import { Icon } from 'astro-icon/components';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ApartmentCard from '../../components/ApartmentCard.astro';
import FAQAccordion from '../../components/FAQAccordion.astro';
import RichText from '../../components/RichText.astro';
import { getTranslation } from '../../i18n/translations';
import { buildLocalBusinessSchema, buildOrganizationSchema, buildWebsiteSchema, getSiteOrigin } from '../../lib/seo';

const lang = 'en' as const;
const t = getTranslation(lang);

const siteOrigin = getSiteOrigin(Astro.site);

const allApartments = await getCollection('apartments');
const sortedApartments = allApartments.sort((a, b) => a.data.order - b.data.order);

const homePage = await getEntry('pages', 'home');
const hero = homePage.data.hero!;
const sectionSubheadline = homePage.data.sectionSubheadline!;
const features = homePage.data.features!;
const editorialBlocks = homePage.data.editorialBlocks ?? [];
const seo = homePage.data.seo;

const faqPage = await getEntry('pages', 'faq');
const faqItems = faqPage.data.faq ?? [];
const localizedFaq = faqItems.map((item) => ({
  question: item.question[lang],
  answer: item.answer[lang],
}));
const structuredData = [
  buildOrganizationSchema(siteOrigin, lang),
  buildLocalBusinessSchema(siteOrigin, lang),
  buildWebsiteSchema(siteOrigin, lang),
];

const apartmentsAnchorId = 'apartments';
const availableApartmentCount = sortedApartments.filter((apt) => apt.data.available).length;
const minPrice = sortedApartments.length > 0
  ? Math.min(...sortedApartments.map((apt) => apt.data.pricePerMonth))
  : null;

const quickFacts = [
  { label: 'Walk to WHU', value: '2 minutes' },
  { label: 'Available apartments', value: `${availableApartmentCount} of ${sortedApartments.length}` },
  { label: 'Rent from', value: minPrice !== null ? `€${minPrice} / month` : 'On request' },
];

const conceptIntro = [
  'VallendarWohnen offers furnished student apartments for anyone looking for short routes, clear terms, and a dependable living setup during their studies.',
  'Our concept combines fully equipped units with transparent monthly costs and a straightforward booking process that also works from abroad.',
];

const conceptCards = [
  {
    title: 'Ideal for Bachelor and Master students',
    bullets: [
      'Minimum stay: 2 semesters / 12 months',
      'Fully furnished and equipped',
      minPrice !== null ? `From €${minPrice} per month` : 'Transparent monthly rent terms',
    ],
  },
  {
    title: 'Ideal for exchange students',
    bullets: [
      'Minimum stay: 1 semester / 4 to 6 months',
      'Remote viewings and digital contracts available',
      'Support with registration and move-in documents',
    ],
  },
];
---

<BaseLayout
  title={(seo?.title?.[lang]?.trim() || "Furnished Student Apartments in Vallendar | VallendarWohnen")}
  description={(seo?.description?.[lang]?.trim() || "Furnished apartments for students in Vallendar, right across from WHU. From €490/month, fully equipped with Wi-Fi and fitted kitchen.")}
  ogImage={(seo?.ogImage?.trim() || undefined)}
  ogImageAlt={(seo?.ogImageAlt?.[lang] || "Furnished student apartments in Vallendar")}
  structuredData={structuredData}
  lang={lang}
>
  <Fragment slot="head">
    <link rel="preload" as="image" href={hero.images.mobile} media="(max-width: 640px)" />
    <link rel="preload" as="image" href={hero.images.tablet} media="(max-width: 1024px)" />
    <link rel="preload" as="image" href={hero.images.desktop} media="(min-width: 1025px)" fetchpriority="high" />
  </Fragment>

  <!-- Hero Section /* Golden-ratio spacing rhythm: 1.3125, 2.125, 3.4375, 5.5625, 8.9375rem */ -->
  <section class="relative flex min-h-[56svh] items-center overflow-hidden pb-[3.4375rem] pt-[5.5625rem] sm:min-h-[62vh]">
    <div class="absolute inset-0">
      <picture>
        <source media="(max-width: 640px)" srcset={hero.images.mobile} />
        <source media="(max-width: 1024px)" srcset={hero.images.tablet} />
        <img
          src={hero.images.desktop}
          alt=""
          width="2400"
          height="1350"
          loading="eager"
          decoding="async"
          fetchpriority="high"
          class="h-full w-full object-cover"
          aria-hidden="true"
        />
      </picture>
    </div>
    <div class="absolute inset-0 bg-gradient-to-b from-accent-950/75 via-accent-950/55 to-accent-950/75"></div>

    <div class="relative z-10 mx-auto max-w-5xl px-4 text-center sm:px-6">
      <h1 data-animate="fade-in" class="font-serif text-4xl font-extrabold leading-tight text-white sm:text-5xl md:text-6xl lg:text-7xl">
        {hero.headline[lang]}
      </h1>
      <p data-animate="fade-up" class="mx-auto mt-[2.125rem] max-w-3xl text-lg leading-relaxed text-white/90 sm:text-xl">
        {hero.subheadline[lang]}
      </p>
      <div class="mt-[3.4375rem]">
        <a
          href={`#${apartmentsAnchorId}`}
          class="inline-flex items-center gap-2 rounded-full bg-white px-[1.375rem] py-[0.85rem] text-sm font-semibold text-neutral-900 transition-colors hover:bg-neutral-100"
        >
          {hero.cta[lang]}
          <Icon name="lucide:arrow-down" class="h-4 w-4" />
        </a>
      </div>
    </div>
  </section>

  <!-- Quick Facts Section -->
  <section class="bg-neutral-100 pb-[3.4375rem] pt-[1.3125rem] sm:pb-[5.5625rem] sm:pt-[2.125rem]">
    <div class="mx-auto max-w-7xl px-4 sm:px-6">
      <div class="mx-auto max-w-5xl">
        <p class="text-center text-xs font-semibold uppercase tracking-[0.16em] text-neutral-500">
          At a glance
        </p>
        <div class="mt-[1.3125rem] grid gap-[1.3125rem] sm:grid-cols-3">
          {quickFacts.map((fact) => (
            <article class="rounded-2xl bg-white px-[1.3125rem] py-[2.125rem] text-center ring-1 ring-neutral-200">
              <p class="text-xs uppercase tracking-[0.08em] text-neutral-500">{fact.label}</p>
              <p class="mt-[0.8125rem] text-lg font-semibold text-neutral-900">{fact.value}</p>
            </article>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Features / Highlights Section -->
  <section class="bg-neutral-100 pb-[5.5625rem] sm:pb-[8.9375rem]">
    <div class="mx-auto max-w-7xl px-4 sm:px-6">
      <h2 data-animate="fade-in" class="text-center font-serif text-3xl font-bold text-neutral-900 sm:text-4xl">
        {t.sections.features}
      </h2>
      <div data-animate-stagger class="mt-[2.125rem] grid gap-[1.3125rem] sm:mt-[3.4375rem] sm:gap-[2.125rem] sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6">
        {features.map((feature) => (
          <div data-animate="fade-in" class="flex min-h-[12.875rem] flex-col items-center justify-center rounded-3xl bg-white p-[1.3125rem] text-center ring-1 ring-neutral-200 transition-all duration-200 hover:-translate-y-1 hover:shadow-lg sm:p-[2.125rem]">
            <span class="flex h-12 w-12 items-center justify-center rounded-full bg-neutral-100 text-neutral-900">
              <Icon name={`lucide:${feature.icon}`} class="h-5 w-5" />
            </span>
            <span class="mt-[1.3125rem] text-base font-semibold text-neutral-800">{feature.label[lang]}</span>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Apartment Cards Section -->
  <section id={apartmentsAnchorId} class="bg-white py-[5.5625rem] sm:py-[8.9375rem]">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      <h2 data-animate="fade-in" class="text-center font-serif text-3xl font-bold text-neutral-900 sm:text-4xl">
        {t.sections.apartments}
      </h2>
      <RichText content={sectionSubheadline[lang]} className="mx-auto mt-[1.3125rem] max-w-2xl text-center" />

      <div data-animate-stagger class="mt-[3.4375rem] grid gap-[2.125rem] sm:mt-[5.5625rem] sm:grid-cols-2 lg:grid-cols-3">
        {sortedApartments.map((apt) => (
          <div data-animate="fade-up">
            <ApartmentCard apartment={apt} lang={lang} />
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Concept Section -->
  <section class="bg-neutral-100 py-[5.5625rem] sm:py-[8.9375rem]">
    <div class="mx-auto max-w-7xl px-4 sm:px-6">
      <h2 data-animate="fade-in" class="text-center font-serif text-4xl font-bold text-neutral-900 sm:text-5xl">
        Our Concept
      </h2>

      <div data-animate="fade-up" class="mt-[3.4375rem] rounded-3xl border border-neutral-200 bg-neutral-50 p-[2.125rem] sm:p-[3.4375rem] lg:p-[5.5625rem]">
        <div class="space-y-[1.3125rem] text-lg leading-relaxed text-neutral-600">
          {conceptIntro.map((paragraph) => (
            <p>{paragraph}</p>
          ))}
        </div>

        <div class="mt-[3.4375rem] grid gap-[2.125rem] lg:grid-cols-2">
          {conceptCards.map((card) => (
            <article class="rounded-2xl bg-white p-[2.125rem] ring-1 ring-neutral-200 shadow-sm">
              <h3 class="font-serif text-2xl font-semibold text-neutral-900">{card.title}</h3>
              <div class="mt-[1.3125rem] h-px bg-neutral-200"></div>
              <ul class="mt-[2.125rem] space-y-[1.3125rem]">
                {card.bullets.map((bullet) => (
                  <li class="flex items-start gap-3 text-base text-neutral-700">
                    <Icon name="lucide:circle-dot" class="mt-0.5 h-4 w-4 shrink-0 text-neutral-900" />
                    <span>{bullet}</span>
                  </li>
                ))}
              </ul>
            </article>
          ))}
        </div>

        {editorialBlocks.length > 0 && (
          <div class="mt-[3.4375rem] space-y-[1.3125rem] border-t border-neutral-200 pt-[3.4375rem]">
            {editorialBlocks.map((block) => (
              block.type === 'richText' ? (
                <div class="editorial-block editorial-block-info">
                  <RichText content={block.body[lang]} />
                </div>
              ) : block.type === 'callout' ? (
                <div class:list={[
                  'editorial-block',
                  block.tone === 'success'
                    ? 'editorial-block-success'
                    : block.tone === 'warning'
                      ? 'editorial-block-warning'
                      : 'editorial-block-info',
                ]}>
                  <h3 class="font-serif text-xl font-bold text-neutral-900">{block.title[lang]}</h3>
                  <RichText content={block.body[lang]} className="mt-3" />
                </div>
              ) : (
                <div class="editorial-block editorial-block-info flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                  <p class="text-sm font-medium text-neutral-800">{block.text[lang]}</p>
                  <a
                    href={block.buttonHref[lang]}
                    class="inline-flex items-center gap-2 rounded-full bg-accent-700 px-5 py-2.5 text-sm font-semibold text-white transition-colors hover:bg-accent-800"
                  >
                    {block.buttonLabel[lang]}
                    <Icon name="lucide:arrow-right" class="h-4 w-4" />
                  </a>
                </div>
              )
            ))}
          </div>
        )}
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  {localizedFaq.length > 0 && (
    <section id="faq" class="bg-white py-[5.5625rem] sm:py-[8.9375rem]">
      <div class="mx-auto max-w-3xl px-4 sm:px-6">
        <h2 data-animate="fade-in" class="text-center font-serif text-3xl font-bold text-neutral-900 sm:text-4xl">
          {t.sections.faq}
        </h2>
        <div data-animate="fade-up" class="mt-[3.4375rem]">
          <FAQAccordion items={localizedFaq} />
        </div>
      </div>
    </section>
  )}
</BaseLayout>
