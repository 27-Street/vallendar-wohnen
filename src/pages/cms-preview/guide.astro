---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import FAQAccordion from '../../components/FAQAccordion.astro';
import RichText from '../../components/RichText.astro';
import { GUIDE_PREVIEW_FIELD_MAP } from '../../lib/cms-preview/field-map';
import {
  RICH_TEXT_ALLOWED_ATTRIBUTES,
  RICH_TEXT_ALLOWED_TAGS,
  RICH_TEXT_CONFIG_SIGNATURE,
} from '../../lib/rich-text-config';

const lang = 'de' as const;
const guides = await getCollection('guides');
const sortedGuides = guides.sort((a, b) => a.data.order - b.data.order);
const fallbackGuide = {
  id: 'draft-guide',
  data: {
    title: { de: 'Neuer Guide', en: 'New guide' },
    description: { de: 'Beschreibung im CMS ausfuellen.', en: 'Fill in guide description from CMS.' },
    excerpt: { de: '', en: '' },
    publishedAt: '',
    readingMinutes: 1,
    category: 'living' as const,
    order: 1,
    sections: [],
    seo: {
      title: { de: '', en: '' },
      description: { de: '', en: '' },
    },
  },
};
const guide = sortedGuides[0] ?? fallbackGuide;
const localizedFaq = (guide.data.faq ?? []).map((item) => ({
  question: item.question[lang],
  answer: item.answer[lang],
}));

const bootstrapPayload = {
  page: 'guide',
  collection: 'guides',
  slug: guide.id,
  locale: 'de',
  highlight: false,
  activePath: null,
  data: guide.data,
  resolvedAssets: {},
  sentAt: Date.now(),
};

const richTextConfig = {
  allowedTags: [...RICH_TEXT_ALLOWED_TAGS],
  allowedAttributes: Array.from(new Set(Object.values(RICH_TEXT_ALLOWED_ATTRIBUTES).flat())),
  signature: RICH_TEXT_CONFIG_SIGNATURE,
};

const seo = guide.data.seo;
---

<BaseLayout
  title="CMS Preview — Guide"
  description="Visual preview route for Decap CMS guide editing"
  lang={lang}
  noindex={true}
>
  <Fragment slot="head">
    <meta name="robots" content="noindex, nofollow" />
    <script
      is:inline
      define:vars={{
        bootstrapPayload,
        guideFieldMap: GUIDE_PREVIEW_FIELD_MAP,
        richTextConfig,
      }}
    >
      window.__CMS_PREVIEW_BOOTSTRAP__ = {
        page: 'guide',
        locale: bootstrapPayload.locale,
        fieldMap: guideFieldMap,
        richTextConfig,
        initialPayload: bootstrapPayload,
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.5/dist/purify.min.js"></script>
    <script is:inline src="/admin/preview-frame.js"></script>
    <style>
      [data-cms-path] {
        scroll-margin-top: 96px;
      }

      .cms-preview-highlightable {
        outline: 1px dashed rgba(54, 79, 51, 0.4);
        outline-offset: 4px;
      }

      .cms-preview-highlight-active {
        outline: 2px solid rgba(54, 79, 51, 0.8);
        outline-offset: 4px;
      }
    </style>
  </Fragment>

  <section class="bg-gradient-to-br from-accent-950 via-accent-800 to-accent-950 pb-16 pt-32">
    <div class="mx-auto max-w-5xl px-4 sm:px-6">
      <a href="/de/guides/" class="text-sm font-semibold text-accent-200 hover:text-white">← Zurück zu allen Guides</a>
      <h1 data-cms-path="title" class="mt-4 font-serif text-4xl font-bold text-white sm:text-5xl">{guide.data.title.de}</h1>
      <p data-cms-path="description" class="mt-4 max-w-3xl text-lg text-accent-100/85">{guide.data.description.de}</p>
      <p data-cms-path="publishedAt" class="mt-3 text-sm font-medium text-accent-200">{guide.data.publishedAt} · {guide.data.readingMinutes} Min. Lesezeit</p>
    </div>
  </section>

  <section class="bg-white py-16 sm:py-20">
    <div data-cms-path="sections" class="mx-auto max-w-4xl space-y-10 px-4 sm:px-6">
      {guide.data.sections.map((section) => (
        <article>
          <h2 class="font-serif text-2xl font-bold text-neutral-900">{section.heading.de}</h2>
          <RichText content={section.body.de} className="mt-4" />
        </article>
      ))}
    </div>
  </section>

  <section class="bg-neutral-50 py-16 sm:py-20">
    <div class="mx-auto max-w-4xl px-4 sm:px-6">
      <h2 class="font-serif text-3xl font-bold text-neutral-900">Häufige Fragen</h2>
      <div data-cms-path="faq" class="mt-8">
        <FAQAccordion items={localizedFaq} />
      </div>
    </div>
  </section>

  <section class="bg-white py-16">
    <div class="mx-auto max-w-4xl px-4 sm:px-6">
      <div class="rounded-3xl border border-neutral-200 bg-neutral-50 p-6 sm:p-8">
        <h2 class="font-serif text-2xl font-bold text-neutral-900">SEO Vorschau</h2>
        <p class="mt-5 text-xs font-semibold uppercase tracking-[0.12em] text-neutral-500">SEO Title</p>
        <p data-cms-path="seo.title" class="mt-2 text-lg font-semibold text-neutral-900">{seo?.title?.de}</p>

        <p class="mt-6 text-xs font-semibold uppercase tracking-[0.12em] text-neutral-500">SEO Description</p>
        <p data-cms-path="seo.description" class="mt-2 text-sm leading-relaxed text-neutral-600">{seo?.description?.de}</p>

        <p class="mt-6 text-xs font-semibold uppercase tracking-[0.12em] text-neutral-500">OpenGraph Image</p>
        <img data-cms-path="seo.ogImage" src={seo?.ogImage} alt="" class="mt-2 max-h-52 w-full rounded-2xl object-cover ring-1 ring-neutral-200" />
      </div>
    </div>
  </section>
</BaseLayout>
